import sqlite3
import requests
import time
from flask import Flask, jsonify
from flask_cors import CORS

app = Flask(__name__)
CORS(app)  # Allows React to talk to this server

# --- CONFIGURATION ---
ESP_URL = "http://192.168.10.1/data"
DB_NAME = "risk_ai.db"

# --- DATABASE SETUP ---
def init_db():
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    # Create table for history
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS records (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            temperature REAL,
            humidity REAL,
            co2 REAL,
            aceton REAL,
            timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    conn.commit()
    conn.close()

# --- ROUTES ---
@app.route('/api/fetch-sensor', methods=['GET'])
def get_sensor_data():
    data = {}
    try:
        # 1. Get Data from ESP32 (Engineer A)
        response = requests.get(ESP_URL, timeout=2)
        data = response.json()
        
        # 2. Save to Database
        conn = sqlite3.connect(DB_NAME)
        cursor = conn.cursor()
        cursor.execute('''
            INSERT INTO records (temperature, humidity, co2, aceton)
            VALUES (?, ?, ?, ?)
        ''', (data.get('temperature', 0), data.get('humidity', 0), 
              data.get('co2', 0), data.get('aceton', 0)))
        conn.commit()
        conn.close()
        
        print(f"Saved Record: {data}") # Debug print
        
    except Exception as e:
        print(f"Error connecting to ESP32: {e}")
        return jsonify({"error": "Sensor Disconnected"}), 500

    return jsonify(data)

@app.route('/api/history', methods=['GET'])
def get_history():
    conn = sqlite3.connect(DB_NAME)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM records ORDER BY id DESC LIMIT 20')
    rows = cursor.fetchall()
    conn.close()
    return jsonify([dict(row) for row in rows])

if __name__ == '__main__':
    init_db()
    print("RiskAI Backend Running...")
    print(f"Connecting to ESP32 at {ESP_URL}")
    app.run(debug=True, port=5000)